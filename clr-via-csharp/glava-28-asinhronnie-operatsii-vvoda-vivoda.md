# Глава 28. Асинхронные операции ввода-вывода

### Оставшиеся вопросы

1. Как будет обрабатываться ситуация, если в методе происходит вылет исключения, этот асинхронный метод возвращает Task, но при этом его никто не ожидает? - Возможно нет никакого специального поведения и во время сборки мусора при вызове Dispose происходит выкидывание этого исключение?

### Операции ввода-вывода в Windows

При асинхронной операции ввода-вывода работа уходит драйверу устройства и поток не блокируется операцией, а ему возвращается управление.

- **Написано, что закончив обработку IRP-пакета устройство \(драйвер?\) помещает делегат в очередь пула потоков - Непонятно, а что если требуется, чтобы запрос обслужил конкретный поток? Тут контекст синхронизации как-то используется.**

- **Используется стандартный механизм из async/await - Если контекст синхронизации был захвачен, то работа уйдёт через него.**

### Асинхронные функции CSharp

### Асинхронные функции и обработчики событий

Обработчики событий в большинстве случаев возвращают void. Если хочется, чтобы обработчик события был асинхронным мы можем захотеть использовать асинхронную функцию в качестве обработчика события \(чтобы использовать в функции await - нужно чтобы функция была помечена async\). При этом обработчик события будет вызываться не асинхронно \(без await\), но нам необходимо, чтобы асинхронная функция развернулась в конечный автомат и асинхронно отработала до конца не блокируя вызывающий поток выполнения.

Для этой возможности асинхронные функции поддерживают возвращаемый результат в виде void. При вызове такой функции будет развёрнут конечный автомат выполнения, но вызывающий поток не будет заблокирован ожиданием выполнения функции до конца. Из этого следует недостаток - вызывающий поток не сможет узнать, что вызываемая функция завершилась.

### Асинхронные функции и старые модели программирования

Асинхронная модель BeginXxx, EndXxx - может быть подключена через использование

```
await Task.Factory.FromAsync(ojb.BeginXxx, obj.EndXxx, null);
```

После этого await код который должен выполняться при этой асинхронной операции.

Событийная модель - можно подключить с использованием `TaskCompletionSource`

Устанавливая у него состояния во время получения событий.

```C\#
var tsc = new TaskCompletionSource<String>();

//Внутри обработчика события
tsc.SetCanceled();
tsc.SetException(error);
tsc.SetResult(result);
```

### Асинхронные функции и исключения

Если метод конечного автомата сталкивается с исключением, то объект Task операции завершается \(в_идимо для TaskCompletionSource устанавливается SetException_\). При await этой задачи вызывающий код получит это исключение. При использовании await выбрасывается первое внутреннее исключение, а не AggregateException.

Если асинхронный метод возвращает void, то код сгенерированный компилятором перехватит исключение и выдаст заново с использованием контекста синхронизации стороны вызова.

То есть последствия будут зависеть от поведения, которое заложено в контекст синхронизации.

