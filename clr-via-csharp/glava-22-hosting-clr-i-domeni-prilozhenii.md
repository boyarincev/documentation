# Глава 22. Хостинг CLR и домены приложений

### Вопросы

1. А в дотнеткоре есть хостинг CLR ? Как теперь работает в линуксе?
2. Что такое com-сервер?

### Хостинг CLR

Это возможность запускать CLR в процессе своего неуправляемого приложения и управлять этой CLR.

#### Зачем это нужно

* Создание программ оболочек над .NET
* Переписать часть своего приложения на управляемый код
* Возможность дать сторонник разработчикам писать расширения для своего приложения на .NET

#### Технические подробности

* CLR работаем как Com-сервер \(**теперь уже нет**\) содержащийся в CLR
* Любое виндовз приложение может стать хостингом CLR
* Дальше расписаны грязные подробности как загрузить CLR в свой процесс \(Суть в том, что DLL с CLR грузится в итоге в этот процесс\)

### Домены приложений

В ходе инициализации ком-сервера CLR создаёт домен приложений - это логический контейнер для сборок.

Первый домен приложений в процессе называется основным и он может быть уничтожен только с процессом.

Дополнительные домены могуть быть созданы хостом, используя методы неуправляемого com-интерфейса или из управляемого кода.

Цель дополнительных доменов - изоляция исполняемого кода.

#### Свойства доменов приложений

* Объекты созданные в одном домене недоступны для прямого доступа в другом домене
* CLR не поддерживает выгрузку из процесса отдельных сборок, однако можно выгрузить домен и вместе с ним все используемые им сборки
* Создаваемому домену можно настраивать разрешения которые будут у используемых им сборок
* Можно определить индивидуальные настройк
* Нет жёстких ограничений количество доменов в процессе

#### Домен и сборки

Сборки грузятся в каждый домен независимо, даже если сборку одну и ту же нужно загрузить в несколько доменов одного процесса.

В каждом домене есть своя куча загрузчика, ведущая учёт обращений к типам с момента создания домена.

В ней каждому типу соответствует таблица методов, в строках которой указатели на код метода.

Если этот метод уже хоть раз исполнялся, его код скомпилирован Джит-компилятороом в машинный код.

**Машинный код методов компилируется независимо в каждом домене**

Сборка MsCorLib.dll загружается автоматически CLR при инициализации и используется всеми доменами совместно - она не привязана к какому-то определённому домену.

#### Доступ к объектам из разных доменов

Доступ возможен

1. По ссылке - будет создан прокси-объект через, который будет осуществляться доступ. Для этого тип должен наследоваться от MarshalByRefObject.
2. По значению - объект может быть скопирован, для этого он должен быть помечен, как сериализуемый \(Serializable атрибут\)

В ином случае будет выкинуто NonMarshalableType исключение



