# Глава 26. Потоки исполнения

Процесс - набор ресурсов выделяемых каждому приложению. Каждому процессу выделяется виртуальное адресное пространство.

Поток - концепция виртуализации процессора.

### Ресурсоёмкость потоков

#### Thread Kernel Object \(объект ядра потока\)

Содержит какую-то инфу, пока неизвестно какую.

Также содержит Контекст потока - блок памяти с набором регистров процессора \(для каждого процессора будет своя\)

#### Thread Environment Block \(TEB\)

Занимает одну страницу памяти.

Содержит

* Заголовок цепочки обработки исключений \(при каждом входе в блок try вставляется новая запись, при выходе из блока try удаляется запись\)
* Локальное хранилище данных поток \(_что там хранится?_\)
* И что-то для видеоподсистемы

#### Стек пользовательского режима \(user-mode stack\)

Стек приложения. По умолчанию на каждый стек пользовательского режима выделяется 1 мегабайт \(_инфа ещё актуальна?_\) и **добавляется физическая память по мене необходимости при росте стека**.

#### Стек режима ядра \(kernel-mode stack\)

Используется, когда код приложения передаёт аргументы в функцию операционной системы. Windows копирует передаваемые аргументы в целях безопасности в стек режима ядра, где к ним уже не имеет доступа код приложения. В 32 битной версии занимает 12 килобайт, в 64 битной - 24 килобайта.

#### Уведомления о создании и завершении потоков

При создании и завершении потоков у всех DLL-библиотек загруженных в процесс вызывается метод DLLMain.

**Библиотеки C\# не имеют метода DLLMain - поэтому для них нет накладных расходов на вызов метода. У неуправляемых библиотек этот вызов тоже можно отключить.**

### Смена потока выполнения

При смене потока происходит сохранение состояния регистров процессора в поток \(в ядро потока\), который прекращает выполнение и регистры заполняются инфой из потока, который начинает выполнение.

### CLR и Windows потоки

Изначально предполагалось, что это будут разные потоки, но затем было принято решение, что они должны быть одним и тем же. Но в API уже были добавлены названия, из-за которых может возникать мнение, что CLR-потоки какая-то отдельная концепция.





